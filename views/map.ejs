<% include header.ejs %>
<script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=cb84c659c88a7cc83b935a009b3a9cfd&plugin=AMap.Walking,AMap.Driving"></script>
</head>
  <style>
    html{
      font-size: 20px;
    }
    body{
      position: absolute;
      left: 0;
      right: 0 !important;
      padding:0;
      margin:0;
      width: 100%;
      overflow: hidden;
      background-color: #E8E8E8;
    }
    #container{
      width: 100%;
      height: 100%;
    }
    .iconfont {
      font-family: "iconfont" !important;
    }
    #panel {
      background-color: white;
      overflow-y: auto;
      width: 100%;
      height: 100%;
      padding-top: 2.2rem;
      /*display: none;*/
    }
    .bar{
      z-index: 1000;
    }
    .icon-daohang{
      color: #ee7e2e!important
    }
  </style>
<body>
  <div class="wenwo-content page page-current" id='map'>
    <header class="bar bar-nav">
      <a class="button button-link button-nav pull-left backDetail">
        <span class="icon iconfont icon-zuo"></span>
      </a>
      <span class="icon iconfont icon-daohang pull-right"></span>
      <h1 class="title">地图</h1>
    </header>
    <div id="container"></div>
  </div>
  <div class="wenwo-content page" id="panelcontent">
    <header class="bar bar-nav">
      <a class="button button-link button-nav pull-left back">
        <span class="icon iconfont icon-zuo"></span>
      </a>
      <h1 class="title">路线</h1>
    </header>
    <div id="panel">
  </div>
</body>
<% include footer.ejs %>
<script type="text/javascript" src="/js/wxlocation.js"></script>
  <script>
  $(".backDetail").on("click",function(){
    window.history.back(-1);
  })
  $.showPreloader("正在加载");

  function initRoad(myLng,myLat,lng,lat){
    var walking = new AMap.Walking({
      map: map,
      panel: "panel"
    }); 
    walking.search([myLng,myLat],[lng,lat],function(status,result){
      console.log(result);
      console.log(status);
      if(status == "error"){
        $.hidePreloader();
        $("#panelcontent .title").text("驾车导航");
        var driving = new AMap.Driving({
          map: map,
          panel: "panel"
        }); 
        driving.search([myLng,myLat],[lng,lat],function(status,result){
          console.log(result);
          console.log(status);
        });
      }else{
        $("#panelcontent .title").text("步行导航");
        $.hidePreloader();
      }
    });
  }

  $(".icon-daohang").on("click",function(){
    $.router.load("#panelcontent");
  })

  var marker;
  var icon = new AMap.Icon({
    image: "/img/edit/marker.png",
  });
  var lat = "<%= lat %>";
  var lng = "<%= lng %>";
  // myLat = 30.580596;
  // myLng = 103.982984;
  if(lat && lng){
    //详情地点显示
    map = new AMap.Map('container', {
      resizeEnable: true,
      zoom:13,
      center: [lng,lat]
      // buttonDom:'<div class="geolocation-position"><img src="/img/position.png"></div>',
      // buttonOffset: new AMap.Pixel(20, 25),//定位按钮与设置的停靠位置的偏移量，默认：Pixel(10, 20)
      // zoomToAccuracy: true,      //定位成功后调整地图视野范围使定位位置及精度范围视野内可见，默认：false
      // buttonPosition:'LB',
      // showCircle:false,
      // useNative:true
    });

    map.plugin(["AMap.ToolBar"], function() {
      map.addControl(new AMap.ToolBar());
    });

     // var walking = new AMap.Walking({
     //    map: map,
     //    panel: "panel"
     //  }); 
     //  walking.search([myLng,myLat],[lng,lat],function(status,result){
     //    console.log(result);
     //    console.log(status);
     //  });
     // $.hidePreloader();
     // var driving = new AMap.Driving({
     //    map: map,
     //    panel: "panel"
     //  }); 
     //  driving.search([myLng,myLat],[lng,lat],function(status,result){
     //    console.log(result);
     //    console.log(status);
     //  });
     // initRoad(myLng,myLat,lng,lat);
  }

  if(navigator.geolocation) { // 判断设备是否支持定位
  　　navigator.geolocation.getCurrentPosition(function(position) { 　　
        //步行导航
        var myLng = position.coords.longitude;
        var myLat = position.coords.latitude;
        // var walking = new AMap.Walking({
        //     map: map,
        //     panel: "panel"
        // }); 
        // $.hidePreloader();
        // walking.search([myLng,myLat],[lng,lat],function(status,result){
        //   console.log(result);
        // });
        initRoad(myLng,myLat,lng,lat);
  　　}, function(error) {
          myLat = 30.580596;
          myLng = 103.982984;
          initRoad(myLng,myLat,lng,lat);
          initLocation({
            success:function(myLng,myLat){
              $.hidePreloader();
              if(myLng && myLat){
                //步行导航
                // var walking = new AMap.Walking({
                //     map: map,
                //     panel: "panel"
                // }); 
                // walking.search([myLng,myLat],[lng,lat],function(status,result){
                //   console.log(result);
                // });
                initRoad(myLng,myLat,lng,lat);
              }else{
                marker = new AMap.Marker({
                  map : map,
                  icon : icon,
                  position: [lng,lat],
                  draggable: false,
                  cursor: 'move',
                  raiseOnDrag: false,
                  clickable:false
                });
                marker.setMap(map);
              }
            },
            error:function(error){
              $.hidePreloader();
              console.log(error);
            }
          });
  　　}, {
  　　　　maximumAge: 0
  　　});
　　}else {
　　　　initLocation({
          success:function(myLng,myLat){
            $.hidePreloader();
            if(myLng && myLat){
              //步行导航
              /*var walking = new AMap.Walking({
                  map: map,
                  panel: "panel"
              }); 
              walking.search([myLng,myLat],[lng,lat],function(status,result){
                console.log(result);
              });*/
              initRoad(myLng,myLat,lng,lat);
            }else{
              marker = new AMap.Marker({
                map : map,
                icon : icon,
                position: [lng,lat],
                draggable: false,
                cursor: 'move',
                raiseOnDrag: false,
                clickable:false
              });
              marker.setMap(map);
            }
          },
          error:function(error){
            console.log(error);
          }
        });
　　}
  </script>
</html>