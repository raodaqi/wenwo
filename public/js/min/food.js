var map="",LAT,LNG,title1=1,title2=1,title3=1;LAT=30.580596;LNG=103.982984;$.showPreloader("正在加载");initLocation({success:function(e,t){LAT=t;LNG=e;addItems(itemsPerLoad,0)},error:function(e){console.log(e)}});$(document).on("refresh",".pull-to-refresh-content",function(e){var t=$(this).parent()[0].id;title1=1;title2=1;title3=1;console.log(t);switch(t){case"find":initFindListPage();break;case"like":$(".want-content").hide();initLikeListPage();break;case"share":initSharePage(UserName);break;case"buy":initBuyPage(UserName);break;default:setTimeout(function(){$.pullToRefreshDone(".pull-to-refresh-content")},1e3);break}});$.initPullToRefresh(".content");function getIfAttention(e){var t={username:e};$.ajax({type:"POST",data:t,dataType:"json",url:"/authorization/isfocus",success:function(e){console.log(e);if(e.code==200){if(!e.isfocus){var t='<div class="isfocus-content"><div class="isfocus-title">关注「问我」才能查看总收益、接收结算通知<br/>长按二维码识别，公众号：wenwolo</div><img src="/img/qr.JPG" class="isfocus-img" alt=""></div>';$(".detail-pic-content").empty().append(t);$(".detail-pic-content").show();$("#me .list-content").hide()}else{$(".detail-pic-content").show();$("#me .list-content").show()}}else{$(".detail-pic-content").show();$("#me .list-content").show()}},error:function(e){$.toast("服务器异常");$(".detail-pic-content").show();$("#me .list-content").show()}})}getIfAttention(UserName);function init(){var e=window.location.hash;if(e){e=e.split("#")[1]}else{e="find"}console.log(e);$(".tab-item").removeClass("active");$("."+e).addClass("active");switch(e){case"share":initSharePage(UserName);break;case"buy":initBuyPage(UserName);break;case"find":break;case"me":initSharePage(UserName);initBuyPage(UserName);break}}function updatePage(e){switch(e){case"#share":initSharePage(UserName);break;case"#buy":initBuyPage(UserName);break;case"#like":initLikeListPage();break;case"#me":initMePage(UserName);break}}function getAskMe(e,t,i,a,o){var i=i?i:1;var a=a?a:"";if(LAT){var s={page:e,size:t,staus:i,position_geo:LAT+","+LNG,username:a}}else{var s={page:e,size:t,staus:i,username:a}}$.ajax({type:"GET",data:s,dataType:"json",url:"/ask/allask",success:function(e){o.success(e)},error:function(e){o.error(e)}})}var timer="";$(".bar").on("doubleTap",function(){console.log($("#find .wenwo-ul").height());var e=1;var t=$("#find .wenwo-ul").height()/100;timer=setInterval(function(){var e=$("#find .find-content").scrollTop();if(e<=0){$("#find .find-content").scrollTop(0);clearInterval(timer)}else{e=e-t;$("#find .find-content").scrollTop(e)}},e)});$(".pull-to-refresh-content").scroll(function(){var e=$("#find .find-content").scrollTop();var t=$("#like .like-content").scrollTop();var i=$("#share .share-content").scrollTop();var a=$("#buy .buy-content").scrollTop();localStorage["findTop"]=e;localStorage["likeTop"]=t;localStorage["shareTop"]=i;localStorage["buyTop"]=a});$("#find .find-content").scroll(function(){var e=$(".title1").length?$(".title1").offset().top:1e4;var t=$(".title2").length?$(".title2").offset().top:1e4;var i=$(".title3").length?$(".title3").offset().top:1e4;var a=$("#find .find-content").scrollTop();if(e<44){$(".distance-fixed").text($(".title1").text())}if(t<50){$(".distance-fixed").text($(".title2").text())}if(i<50){$(".distance-fixed").text($(".title3").text())}$(".distance-fixed").show();if(a<1){$(".distance-fixed").hide()}});function getLikeList(e,t){var e=e?e:"";var i={username:e};$.ajax({type:"POST",data:i,dataType:"json",url:"/hode/foodlikelist",success:function(e){t.success(e)},error:function(e){t.error(e)}})}var loading=false;var itemsPerLoad=20;var getAskLoad=0;function addItems(e,t){var i=parseInt(t/e);if(!getAskLoad){console.log(i);getAskMe(i,e,"",UserName,{success:function(t){console.log(t);var i="";var a=t.data;if(a){for(var o=0;o<a.length;o++){var s=a[o].GeoX;var l=a[o].GeoY;var n=getFlatternDistance(s,l,LAT,LNG);if(n<1e3){if(title1){i+='<div class="title1 distance">距离 < 1KM</div>';title1=0}}else if(n>=1e3&&n<=5e3){if(title2){i+='<div class="title2 distance">距离1KM - 5KM</div>';title2=0}}else{if(title3){i+='<div class="title3 distance">距离 > 5KM</div>';title3=0}}i+='<div class="wenwo-li" data-id='+a[o].objectId+'><div class="up-content"><img src="'+a[o].createByUrl+'" alt="" class="user-pic"><div class="ask-content"><div class="ask-tag">'+formatTag(a[o].askTagStr)+'</div><div class="ask-reason">'+a[o].askReason+'</div></div></div><div class="down-content"><div class="down-like '+(a[o].liked?"liked":"")+'"><span class="icon iconfont icon-likeEat"></span><label class="like-num">'+(a[o].likeNum<0?0:a[o].likeNum)+"</label></div>"+(a[o].score>9?'<div class="down-buy" data-id='+a[o].objectId+">"+a[o].askPrice+"元瞅瞅</div>":'<div class="down-buy free" data-id='+a[o].objectId+">限时免费</div>")+'<div class="down-time">'+formatDate("y.m.d",a[o].createdAt)+"</div></div></div>"}$("#find .wenwo-ul").append(i);initTop();getAskLoad=0;if(e>a.length){$.detachInfiniteScroll($("#find .infinite-scroll"));$("#find .infinite-scroll-preloader .preloader").hide();$("#find .ask-end").show();getAskLoad=1;return}}},error:function(e){}})}getAskLoad=1}if(LAT){var findTop=localStorage.findTop;if(findTop>2077){addItems(40,0)}else{addItems(itemsPerLoad,0)}}var lastIndex=20;$(document).on("infinite",".infinite-scroll-bottom",function(){if(loading)return;loading=true;loading=false;lastIndex=$("#find .wenwo-li").length;console.log(lastIndex);addItems(itemsPerLoad,lastIndex);$.refreshScroller()});$.init();init();function initFindListPage(){getAskMe(0,20,"",UserName,{success:function(e){console.log(e);var t="";var i=e.data;if(i){for(var a=0;a<i.length;a++){var o=i[a].GeoX;var s=i[a].GeoY;var l=getFlatternDistance(o,s,LAT,LNG);if(l<1e3){if(title1){t+='<div class="title1 distance">距离 < 1KM</div>';title1=0}}else if(l>=1e3&&l<=5e3){if(title2){t+='<div class="title2 distance">距离1KM - 5KM</div>';title2=0}}else{if(title3){t+='<div class="title3 distance">距离 > 5KM</div>';title3=0}}t+='<div class="wenwo-li" data-id='+i[a].objectId+'><div class="up-content"><img src="'+i[a].createByUrl+'" alt="" class="user-pic"><div class="ask-content"><div class="ask-tag">'+formatTag(i[a].askTagStr)+'</div><div class="ask-reason">'+i[a].askReason+'</div></div></div><div class="down-content"><div class="down-like '+(i[a].liked?"liked":"")+'"><span class="icon iconfont icon-likeEat"></span><label class="like-num">'+(i[a].likeNum<0?0:i[a].likeNum)+"</label></div>"+(i[a].score>9?'<div class="down-buy" data-id='+i[a].objectId+">"+i[a].askPrice+"元瞅瞅</div>":'<div class="down-buy free" data-id='+i[a].objectId+">限时免费</div>")+'<div class="down-time">'+formatDate("y.m.d",i[a].createdAt)+"</div></div></div>"}$.pullToRefreshDone(".pull-to-refresh-content");$("#find .wenwo-ul").empty();$("#find .wenwo-ul").append(t);initTop();$.attachInfiniteScroll($("#find .infinite-scroll"));$("#find .ask-end").hide();$("#find .infinite-scroll-preloader .preloader").css("display","inline-block");getAskLoad=0}},error:function(e){$.pullToRefreshDone(".pull-to-refresh-content")}})}function initLikeListPage(){getLikeList(UserName,{success:function(e){if(e.code==200){console.log(e);var t="";var i=e.askDetail;if(!i.length){$("#like .infinite-scroll-preloader").hide();$("#like .want-content").show()}if(i){for(var a=0;a<i.length;a++){t+='<div class="wenwo-li" data-id='+i[a].objectId+'><div class="up-content"><img src="'+i[a].createByUrl+'" alt="" class="user-pic"><div class="ask-content"><div class="ask-tag">'+formatTag(i[a].askTagStr)+'</div><div class="ask-reason">'+i[a].askReason+'</div></div></div><div class="down-content"><div class="down-like liked"><span class="icon iconfont icon-likeEat"></span><label class="like-num">'+(i[a].likeNum<0?0:i[a].likeNum)+"</label></div>"+(i[a].score>9?'<div class="down-buy" data-id='+i[a].objectId+">"+i[a].askPrice+"元瞅瞅</div>":'<div class="down-buy free" data-id='+i[a].objectId+">限时免费</div>")+'<div class="down-time">'+formatDate("y.m.d",i[a].createdAt)+"</div></div></div>"}}$.pullToRefreshDone(".pull-to-refresh-content");$("#like .wenwo-ul").empty();$("#like .wenwo-ul").append(t);$("#like .infinite-scroll-preloader .preloader").hide();$("#like .ask-end").show();initTop()}},error:function(e){$.pullToRefreshDone(".pull-to-refresh-content")}})}initLikeListPage();$(".tab-item").on("click",function(){var e=$(this).attr("data-type");var t=$(".active").attr("data-type");console.log(e);$(".tab-item").removeClass("active");$(this).addClass("active");if(e==t){return}if(e=="like"){$(".pull-to-refresh-arrow").hide();$.router.load("#like");setTimeout(function(){$(".pull-to-refresh-arrow").show()},500)}else if(e=="find"){$(".pull-to-refresh-arrow").hide();updatePage("#me");updatePage("#like");$.router.load("#find");setTimeout(function(){$(".pull-to-refresh-arrow").show()},500)}else if(e=="edit"){$.showPreloader("正在跳转");window.location.href="/edit"}});$(".empty-button").on("click",function(){var e=$(this).attr("data-href");if(e.split("#")[1]){$(".tab-item").removeClass("active");$(".find").addClass("active");$.router.load(e)}else{$.showPreloader("正在跳转");$.router.load(e)}});$(".my-ask .item-link").on("click",function(){var e=$(this).attr("data-href");$.router.load(e)});$(".wenwo-ul").on("click",".down-like",function(){var e=$(this).parent().parent().attr("data-id");console.log($(this).parent(".page").id);var t=$(this).children(".like-num").text();console.log($(this).hasClass("liked"));if($(this).hasClass("liked")){t=parseInt(t)-1;$(this).children(".like-num").text(t);$(this).removeClass("liked");cancelLike(UserName,e,this,{success:function(e,i){console.log(e);if(e.code==200){}else{t++;$(i).children(".like-num").text(t);$(i).addClass("liked")}},error:function(e,i){console.log(e);t++;$(i).children(".like-num").text(t);$(i).addClass("liked")}})}else{t=parseInt(t)+1;$(this).children(".like-num").text(t);$(this).addClass("liked");like(UserName,e,this,{success:function(e,i){console.log(e);if(e.code==200){}else{t--;$(i).children(".like-num").text(t);$(i).removeClass("liked")}},error:function(e,i){console.log(e);t--;$(i).children(".like-num").text(t);$(i).removeClass("liked")}})}});$(".wenwo-ul").on("click",".up-content",function(){console.log($(this).parent().attr("data-id"));var e=$(this).parent().attr("data-id");$.showPreloader("正在跳转");window.location.href="/detail?askid="+e+"#food"});$(".list-li-like-num").on("click",function(){$(".tab-item").removeClass("active");$(".like").addClass("active");$.router.load("#like")});$(".list-li-like-share").on("click",function(){$.router.load("#share")});$(".icon-gerenzhongxin").on("click",function(){updatePage("#buy");updatePage("#share");$.router.load("#me")});$("#share .back,#buy .back").on("click",function(){updatePage("#buy");updatePage("#share")});function initMePage(e){if(localStorage.userHead){$("#me .pic-bg,#me .user-pic").attr("src",localStorage.userHead);$("#me .user-name").text(localStorage.userShowName);$("#me .list-li-like-num").text(localStorage.foodLikeListCount);$("#me .list-li-like-share,#me .my-ask .item-share").text(localStorage.askListCount);$("#me .list-li-like-total").text(leaveTwoPoint(localStorage.totalIncome));$("#me .itm-buy").text(localStorage.buyListCount)}var t={username:e};$.ajax({type:"POST",data:t,dataType:"json",url:"/user/getInfo",success:function(e){console.log(e);if(e.code=200){var t=e.data.userHead;var i=e.data.userShowName;var a=e.data.askListCount;var o=e.data.buyListCount;var s=leaveTwoPoint(e.data.totalIncome);var l=e.data.foodLikeListCount;$("#me .pic-bg,#me .user-pic").attr("src",t);$("#me .user-name").text(i);$("#me .list-li-like-num").text(l);$("#me .list-li-like-share,#me .my-ask .item-share").text(a);$("#me .list-li-like-total").text(s);$("#me .itm-buy").text(o);localStorage["userHead"]=t;localStorage["userShowName"]=i;localStorage["askListCount"]=a;localStorage["buyListCount"]=o;localStorage["totalIncome"]=s;localStorage["foodLikeListCount"]=l}},error:function(e){console.log(e)}})}initMePage(UserName);function initBuyPage(e){var t={username:e,staus:1};$.ajax({type:"POST",data:t,dataType:"json",url:"/hode/haved",success:function(e){if(e.code==200){console.log(e);var t="";var i=e.askDetail;if(!i.length){$("#buy .infinite-scroll-preloader").hide();$("#buy .want-content").show()}if(i){for(var a=0;a<i.length;a++){t+='<div class="wenwo-li" data-id='+i[a].objectId+'><div class="up-content"><img src="'+i[a].createByUrl+'" alt="" class="user-pic"><div class="ask-content"><div class="ask-tag">'+formatTag(i[a].askTagStr)+'</div><div class="ask-reason">'+i[a].askReason+'</div></div></div><div class="down-content"><div class="down-like '+(i[a].liked?"liked":"")+'"><span class="icon iconfont icon-likeEat"></span><label class="like-num">'+(i[a].likeNum<0?0:i[a].likeNum)+"</label></div>"+'<div class="down-buy" data-id='+i[a].objectId+">朕已查阅</div>"+'<div class="down-time">'+formatDate("y.m.d",i[a].createdAt)+"</div></div></div>"}}$.pullToRefreshDone(".pull-to-refresh-content");$("#buy .wenwo-ul").empty();$("#buy .wenwo-ul").append(t);$("#buy .infinite-scroll-preloader .preloader").hide();$("#buy .ask-end").show();initTop()}},error:function(e){$.pullToRefreshDone(".pull-to-refresh-content");console.log(e)}})}function initSharePage(e){var t={username:e};$.ajax({type:"GET",data:t,dataType:"json",url:"/ask/myask",success:function(e){if(e.code==200){console.log(e);var t="";var i=e.data;if(!i.length){$("#share .infinite-scroll-preloader").hide();$("#share .want-content").show()}if(i){for(var a=0;a<i.length;a++){t+='<div class="wenwo-li" data-id='+i[a].objectId+'><div class="up-content"><img src="'+i[a].createByUrl+'" alt="" class="user-pic"><div class="ask-content"><div class="ask-tag">'+formatTag(i[a].askTagStr)+'</div><div class="ask-reason">'+i[a].askReason+'</div></div></div><div class="down-content"><div class="down-like '+(i[a].liked?"liked":"")+'"><span class="icon iconfont icon-likeEat"></span><label class="like-num">'+(i[a].likeNum<0?0:i[a].likeNum)+"</label></div>"+'<div class="down-time">'+formatDate("y.m.d",i[a].createdAt)+"</div></div></div>"}}console.log(t);$.pullToRefreshDone("#share .pull-to-refresh-content");$("#share .wenwo-ul").empty();$("#share .wenwo-ul").append(t);$("#share .infinite-scroll-preloader .preloader").hide();$("#share .ask-end").show()}},error:function(e){$.pullToRefreshDone(".pull-to-refresh-content");console.log(e)}})}$(".wenwo-ul").on("click",".down-buy",function(){var e=$(this).attr("data-id");$.showPreloader("正在跳转");$.router.load("/detail?askid="+e)});$(".item-share").on("click",function(){$("#me .modal-overlay-visible").show();$("#me .model-share").show()});$(".modal-in").on("click",function(){$("#me .modal-overlay-visible").hide();$("#me .modal-in").hide()});$(".item-message").on("click",function(){$.showPreloader("正在跳转");$.router.load("http://form.mikecrm.com/Qg7fK7")});$(".icon-tixing").on("click",function(){$("#me .modal-overlay-visible").show();$("#me .model-tip").show()});