$(".tab-item").on("click",function(){var e=$(this).attr("data-type");console.log(e);$(".tab-item").removeClass("active");$(this).addClass("active");if(e=="like"){$.router.load("/food?username=573b0e3df38c8400673bb48d#like")}else if(e=="find"){$.router.load("/food?username=573b0e3df38c8400673bb48d")}});$(".again").on("click",function(){$.router.load("#router");window.location.reload()});$("#success .find").on("click",function(){$.showPreloader("正在出宫");$.router.load("/")});$("#success .pull-right").on("click",function(){$.showPreloader("正在跳转");$.router.load("/")});$("#success .share-btn").on("click",function(){console.log("ok");$("#success .modal-overlay").addClass("modal-overlay-visible");$("#success .modal-overlay").show();$("#success .modal").removeClass("modal-out");$("#success .modal").addClass("modal-in");$("#success .model-share").show()});$("#success .modal-in").on("click",function(){$("#success .modal-overlay-visible").hide();$("#success .modal-in").hide()});$("#router .icon-left").on("click",function(){var e=window.location.hash;if(!e.split("#")[1]){$.showPreloader("正在跳转");window.history.go(-1)}else{$.showPreloader("正在跳转");window.location.href="/food"}});$(".edit-li,.next-view,.pre-view,.circle").on("click",function(){var e=$(this).attr("data-href");if(e.split("#")[1]){$.router.load(e)}else{$.router.load("#"+e)}});$("#router5 .modal-in").on("click",function(){$("#router5 .modal-overlay-visible").hide();$("#router5 .modal-in").hide()});$("#router5 .icon-tixing").on("click",function(){$("#router5 .modal-overlay").addClass("modal-overlay-visible");$("#router5 .modal-overlay").show();$("#router5 .modal").removeClass("modal-out");$("#router5 .modal").addClass("modal-in");$("#router5 .model-tip").show()});initLocation({success:function(){},error:function(){$.toast("定位失败")}});function initMarker(e){e.on("dragend",function(){console.log(this.getPosition());var e=this.getPosition().lat;var t=this.getPosition().lng;$("#container").attr("data-lng",t);$("#container").attr("data-lat",e);localStorage["lng"]=t;localStorage["lat"]=e;var a=[t,e];getAddress(a,{success:function(e){var t=e.formattedAddress;var e={province:e.addressComponent.province,city:e.addressComponent.city,district:e.addressComponent.district,township:e.addressComponent.township};var a=""+e.province+e.city+e.district+e.township+"";t=t.replace(a,"");e.detail=t;var e=JSON.stringify(e);$(".address .edit-content").attr("data-address",e);$(".address .edit-content").text(t);$("#address").val(t)}})})}window.onload=function(){map.plugin(["AMap.ToolBar"],function(){map.addControl(new AMap.ToolBar)});$.hidePreloader()};var id="";$("input,textarea").focus(function(){id=this.id;$(".footer-bar").hide();if(this.id=="address"||this.id=="add-detail"){$(".amap-zoomcontrol").hide();return}$(".header-bar").hide();$(".page-content").css("margin-top","1rem")});$("input,textarea").blur(function(){$(".amap-zoomcontrol").show();$(".footer-bar").show();$(".header-bar").show();$(".page-content").css("margin-top","5rem")});var height=$(document.body).height();$(window).resize(function(){if($(document.body).height()<height){$(".footer-bar").hide();$(".amap-zoomcontrol").hide();if(id!="address"&&id!="add-detail"){$(".header-bar").hide();$(".page-content").css("margin-top","1rem")}}else{$(".footer-bar").show();$(".header-bar").show();$(".amap-zoomcontrol").show();$(".page-content").css("margin-top","5rem")}});$("#router5").on("click",function(){});var u=navigator.userAgent;var isAndroid=u.indexOf("Android")>-1||u.indexOf("Adr")>-1;if(isAndroid){$(".detail-li-name").focus(function(){var e=$("#router3").scrollTop();$("#router3").scrollTop(80)})}function getTag(e){$.showPreloader("正在加载");var t={type:e,size:10};$.ajax({type:"GET",data:t,dataType:"json",url:"/ask/gettag",success:function(e){$.hidePreloader();console.log(e);if(e.code==200){var t="";for(var a in e.data){var i=0;$.each($(".ww-typeHelper .type-item"),function(t,o){if(e.data[a].tagName==$(o).text()){i=1}});console.log(i);if(!i&&e.data[a].tagName){t+='<span class="type-item">'+e.data[a].tagName+"</span>"}}$(".tag-li").empty();$(".tag-li").append(t)}},error:function(e){$.hidePreloader();console.log(e)}})}$("#tag-content,#router1 .next").on("click",function(){console.log(localStorage.type);var e=localStorage.type;if(e){getTag(e)}});var marker;var icon=new AMap.Icon({image:"/img/edit/marker.png"});marker=new AMap.Marker({icon:icon,map:map,draggable:true,cursor:"move",raiseOnDrag:true,clickable:true});marker.setMap(map);initMarker(marker);function getAddress(e,t){var a=new AMap.Geocoder({radius:1e3,extensions:"all"});a.getAddress(e,function(e,a){if(e==="complete"&&a.info==="OK"){var i=a.regeocode;console.log(i);t.success(i);var i={province:i.addressComponent.province,city:i.addressComponent.city,district:i.addressComponent.district}}})}function initLocationData(){console.log(localStorage.tag);if(localStorage.tag){tag=JSON.parse(localStorage.tag);$(".ww-typeHelper-input").val(tag[0]);if(!tag[0]){$(".tag .edit-content").empty().text("请填写标签")}else{$(".tag .edit-li-img").attr("src","/img/edit/tag-02.png");var e='<span class="type-item">'+tag[0]+"</span>";$(".tag .edit-content").empty().append(e)}}console.log(localStorage.reason);if(localStorage.reason){$(".reason .edit-li-img").attr("src","/img/edit/reason-02.png");$("#reason").val(localStorage.reason);$(".reason .edit-content").text(localStorage.reason)}console.log(localStorage.detail);if(localStorage.detail){$("#detail").val(localStorage.detail);$(".edit-detail").text(localStorage.detail)}if(localStorage.detailLi){detailLi=JSON.parse(localStorage.detailLi);if(detailLi.length){$(".detail-li-content").empty();$(".edit-detail-li-content").empty();for(var t=0;t<detailLi.length;t++){var a='<div class="detail-li"><div class="detail-li-title"><input type="text" name="detailName'+t+'" class="detail-li-name" placeholder="填写" value="'+detailLi[t].name+'"></div><div class="detail-li-input"><input type="text" name="detailVal'+t+'" class="detail-li-val" placeholder="可以在此进行补充描述哦" value="'+detailLi[t].val+'"></div><div class="icon iconfont icon-jian"></div></div>';$(".detail-li-content").append(a);$(".detail-li-all-content").scrollTop(1e3);var a='<div class="edit-detail-li"><div class="edit-detail-li-title">'+detailLi[t].name+'</div><div class="edit-detail-li-input">'+detailLi[t].val+"</div></div>";$(".edit-detail-li-content").append(a)}}}if(localStorage.adetail){$("#add-detail").val(localStorage.adetail)}if(localStorage.name){$(".name .edit-li-img").attr("src","/img/edit/name-02.png");$("#name").val(localStorage.name);$(".name .edit-content").text(localStorage.name)}console.log(localStorage.lng);console.log(localStorage.lat);var i=[localStorage.lng,localStorage.lat];if(localStorage.lng&&localStorage.lat){getAddress(i,{success:function(e){var t=e.formattedAddress;var e={province:e.addressComponent.province,city:e.addressComponent.city,district:e.addressComponent.district,township:e.addressComponent.township};var a=""+e.province+e.city+e.district+e.township+"";t=t.replace(a,"");e.detail=t;e=JSON.stringify(e);$(".address .edit-content").attr("data-address",e);$(".address .edit-content").text(t)}});$("#container").attr("data-lng",localStorage.lng);$("#container").attr("data-lat",localStorage.lat);map=new AMap.Map("container",{resizeEnable:true,zoom:15,center:[localStorage.lng,localStorage.lat],buttonOffset:new AMap.Pixel(60,20),zoomToAccuracy:true,buttonPosition:"LB"});marker=new AMap.Marker({map:map,icon:icon,position:[localStorage.lng,localStorage.lat],draggable:true,cursor:"move",raiseOnDrag:true,clickable:true});marker.setMap(map);initMarker(marker)}if(localStorage.price){$("#price").val(localStorage.price);$(".price .edit-li-img").attr("src","/img/edit/price-02.png");$(".price .edit-content").text("￥"+localStorage.price)}}function formatDetail(e){console.log(e);var t=e.staus,a=e.askTagStr,i=e.askReason,o=e.askContentHide,n=e.askContentShow,r=[e.GeoX,e.GeoY],l=e.GeoX,s=e.GeoY,c=e.askPrice,d=e.updatedAt,p=e.createBy;var g=JSON.parse(a);console.log(g);var v="";for(var u in g){console.log(g[u]);var v=v+'<span class="type-item">'+g[u].tag_name+"</span>"}$(".ww-typeHelper-left").before(v);$("#tag-content .card-content-inner").append(v);$("#reason").val(i);$("#reason-content .card-content-inner").text(i);var m=n.split("##");var f=o.split("##");var h="";console.log("len:"+f.length);for(var u=0;u<f.length;u++){if(f[u]){h+=m[u]+"##"+f[u]+"##"}}if(!f.length){h=m}$("#detail-content .card-content-inner").text(h);$("#detail").val(h);deShow(h);getAddress(r,{success:function(e){var t=e.formattedAddress;var e={province:e.addressComponent.province,city:e.addressComponent.city,district:e.addressComponent.district,township:e.addressComponent.township};var a=""+e.province+e.city+e.district+e.township+"";t=t.replace(a,"");e.detail=t;e=JSON.stringify(e);console.log(e);$("#address-content .item-inner").attr("data-address",e);$("#address-content .item-inner").text(t)}});$("#container").attr("data-lng",s);$("#container").attr("data-lat",l);map=new AMap.Map("container",{resizeEnable:true,zoom:15,center:[s,l],buttonOffset:new AMap.Pixel(60,20),zoomToAccuracy:true,buttonPosition:"LB"});marker=new AMap.Marker({map:map,icon:icon,position:[s,l],draggable:true,cursor:"move",raiseOnDrag:true,clickable:true});marker.setMap(map);initMarker(marker);console.log(c);if(c){$("#price-picker").val(c);$("#price-content .item-inner").text(c)}}function initEditData(e){$.ajax({type:"get",url:"/ask/askdetail",data:{ask_id:e,username:UserName},dataType:"json",success:function(e){console.log(e);if(e.code==200){formatDetail(e.data)}},error:function(e){$.alert("网络异常")}})}if(sendType=="edit"){console.log("edit");$("#router .title").text("编辑");initEditData(sendAskId)}else{$("#router .title").text("分享");initLocationData()}$(".card,.theme-list-content").on("click",function(){var e=$(this).data("href");if(e){$.router.load("#"+e)}});$("#router3").on("click",".icon-jian",function(){console.log("123");$(this).parent().remove();var e=getAllDetailLiV();if(e.length){$(".edit-detail-li-content").empty();for(var t=0;t<e.length;t++){var a='<div class="edit-detail-li"><div class="edit-detail-li-title">'+e[t].name+'</div><div class="edit-detail-li-input">'+e[t].val+"</div></div>";$(".edit-detail-li-content").append(a)}}else{$(".edit-detail-li-content").empty()}e=JSON.stringify(e);console.log(e);localStorage["detailLi"]=e});$(".help").on("click",function(){if($(".help-content").hasClass("help-content-active")){$(".help-content").hide();$(".help-content").removeClass("help-content-active")}else{$(".help-content").show();$(".help-content").addClass("help-content-active")}});function setlocalStorageTag(){var e=$(".ww-typeHelper-input").val();var t={};t[0]=e;t=JSON.stringify(t);localStorage["tag"]=t}$(".ww-typeHelper-input").on("input change",function(){console.log($(this).val());var e=$(this).val();setlocalStorageTag();var t='<span class="type-item">'+e+"</span>";$(".tag .edit-content").empty().append(t);if(e.length<=0){$(".tag .edit-content").empty().text("请填写标签")}});$(".tag-ul").on("click",".type-item",function(){console.log($(".tag-content .ww-typeHelper .type-item").length);var e=$(this).text();$(".ww-typeHelper-input").val(e);setlocalStorageTag();var t='<span class="type-item">'+e+"</span>";$(".tag .edit-content").empty().append(t)});$("#reason").on("input change",function(){$("#reason").text($(this).val());localStorage["reason"]=$(this).val();$(".reason .edit-content").text($(this).val())});$(".detail-add").on("click",function(){var e=$(".detail-li").length;console.log(e);var t='<div class="detail-li"><div class="detail-li-title"><input type="text" name="detailName'+e+'" class="detail-li-name" placeholder="填写"></div><div class="detail-li-input"><input type="text" name="detailVal'+e+'" class="detail-li-val" placeholder="请在此对卡片内容进行描述"></div><div class="icon iconfont icon-jian"></div></div>';$(".detail-li-content").append(t);$(".detail-li-all-content").scrollTop(1e3)});function getAllDetailLiV(){var e=[];var t=0;$(".detail-li").each(function(a,i){var o=$(this).children(".detail-li-title").children("input").val();var n=$(this).children(".detail-li-input").children("input").val();var r={};if(o&&n){r.name=o;r.val=n;e[t]=r;t++}});return e}function initMap(e){map=new AMap.Map("container",{resizeEnable:true,zoom:19,center:e,buttonOffset:new AMap.Pixel(60,20),zoomToAccuracy:true,buttonPosition:"LB"})}$(".detail-li-all-content").on("input change","input",function(){var e=getAllDetailLiV();if(e.length){$(".edit-detail-li-content").empty();for(var t=0;t<e.length;t++){var a='<div class="edit-detail-li"><div class="edit-detail-li-title">'+e[t].name+'</div><div class="edit-detail-li-input">'+e[t].val+"</div></div>";$(".edit-detail-li-content").append(a)}}else{$(".edit-detail-li-content").empty()}e=JSON.stringify(e);console.log(e);localStorage["detailLi"]=e});$(".eg-li").on("click",function(){var e=$(this).text();var e=e.split(":")[1];$("#reason").val(e);$(".reason .edit-content").text(e);localStorage["reason"]=e});$("#add-detail").on("input change",function(){localStorage["adetail"]=$(this).val()});$("#detail").on("input change",function(){var e=$("#detail").val();$(".edit-detail").text(e);localStorage["detail"]=$("#detail").val()});$("#name").on("input change",function(){$("#name").text($(this).val());localStorage["name"]=$(this).val();$(".name .edit-content").text($(this).val())});$("#price").on("input change",function(){var e=$(this).val();var t=parseFloat(e);if(!e){e=0;$.toast("只能输入数字且不能为空");return}if(t!=e||isNaN(e)){$.toast("输入格式不对");return}if(t>5){$.toast("输入价格不能高于5元");return}if(t<0){$.toast("输入价格不能小于0元");return}localStorage["price"]=$(this).val();$(".price .edit-content").text("￥"+$(this).val())});window.onpopstate=function(e){$("#address").blur()};var sendClick=0;$(".send-button-a").on("click",function(){if(sendClick){return}var e=new Array,t,a={},i,o,n,r=0;var l=$(".ww-typeHelper-input").val();if(!l){$.toast("你还没有填写美食的类别");return}else{e[0]={tag_name:l};e=JSON.stringify(e)}var t=$("#reason").val();if(!t){$.toast("你还没有填写推荐理由");return}var s=$("#detail").val();if(s){var c=getAllDetailLiV();a.detail=s;if(c.length){c=JSON.stringify(c);a.detailLi=c}}else{var c=getAllDetailLiV();if(!c.length){$.toast("你还没有填写任何信息详情");return}else{c=JSON.stringify(c);a.detailLi=c}}a=JSON.stringify(a);var i=$("#name").val();if(!i){$.toast("你还没有填写店名");return}n=$("#container").attr("data-lng");o=$("#container").attr("data-lat");if(!n||!o){$.toast("你还没有添加地图标注");return}var d=$(".address .edit-content").attr("data-address");if(d){var p=$("#add-detail").val();if(p){d=JSON.parse(d);d.adetail=p;d=JSON.stringify(d)}console.log(d)}if(!d){$.toast("你地图没有标注上");return}r=$("#price").val().replace(/\s+/g,"");var g=parseFloat(r);if(!r){r=0;return}if(g!=r){$.toast("信息价格格式不对");return}if(g>5){$.toast("信息价格不能高于5元");return}if(g<0){$.toast("信息价格不能小于0元");return}var r=g.toFixed(1);if(r==0){r=0}if(o>90){var v=o;o=n;n=v}var u={username:UserName,type:1,tag:e,reason:t,content_show:a,content_hide:"no",position:d,geo_x:o,geo_y:n,shop_name:i,price:r};console.log(u);$.showPreloader("正在分享");sendClick=1;if(sendType=="edit"){u["ask_id"]=sendAskId;$.ajax({type:"POST",data:u,dataType:"json",url:"/ask/askedit",success:function(e){console.log(e);sendClick=0;if(e.code){$.hidePreloader();$.toast("分享成功");localStorage.clear();var t=e.data;WX_SHARE_LINK="http://www.wenwobei.com/detail?askid="+t.objectId;WX_SHARE_IMGURL=t.createByUrl;WX_SHARE_DESC=t.askReason;var a=t.askPosition;a=JSON.parse(a);s=a.detail;if(s.length<=8){s=s}else{s=deatil.substr(0,8)+"..."}WX_SHARE_TITLE="我分享了「"+s+"」附近的美食,瞅瞅波？";initShare();$.router.load("#success")}else{$.toast("分享失败");$.hidePreloader();$.toast(e.message)}},error:function(e){$.hidePreloader();$.toast("服务器异常")}})}else{$.ajax({type:"POST",data:u,dataType:"json",url:"/ask/sendask",success:function(e){console.log(e);sendClick=0;if(e.code==200){$.hidePreloader();$.toast("分享成功");localStorage.clear();var t=e.data.objectId;$.showPreloader("正在跳转");var a=e.data;WX_SHARE_LINK="http://www.wenwobei.com/detail?askid="+a.objectId;WX_SHARE_IMGURL=a.createByUrl;WX_SHARE_DESC=a.askReason;var i=a.askPosition;i=JSON.parse(i);s=i.detail;WX_SHARE_TITLE="我分享了"+s+"的美食,瞅瞅波？";initShare();$.router.load("#success")}else{$.toast("分享失败");$.hidePreloader();$.toast(e.message)}},error:function(e){sendClick=0;$.hidePreloader();$.toast("服务器异常")}})}});$("#address").on("input change",function(){localStorage["address"]=$(this).val()});var timeIv;AMap.plugin(["AMap.Autocomplete","AMap.PlaceSearch"],function(){var e={input:"address"};autocomplete=new AMap.Autocomplete(e);var t=new AMap.PlaceSearch({map:map});AMap.event.addListener(autocomplete,"select",function(e){t.setCity(e.poi.adcode);t.search(e.poi.name,function(e,t){console.log(t);if(t.info=="OK"){var a=t.poiList.pois[0].location.lng;var i=t.poiList.pois[0].location.lat;var o=[a,i];map.setZoomAndCenter(19,o);getAddress(o,{success:function(e){var t=e.formattedAddress;var e={province:e.addressComponent.province,city:e.addressComponent.city,district:e.addressComponent.district,township:e.addressComponent.township};var a=""+e.province+e.city+e.district+e.township+"";t=t.replace(a,"");e.detail=t;var e=JSON.stringify(e);$(".address .edit-content").attr("data-address",e);$(".address .edit-content").text(t);$("#address").val(t)}});localStorage["lng"]=a;localStorage["lat"]=i;$("#container").attr("data-lng",a);$("#container").attr("data-lat",i);map.clearMap();marker=new AMap.Marker({icon:icon,map:map,position:o,draggable:true,cursor:"move",raiseOnDrag:true,clickable:true});marker.setMap(map);initMarker(marker)}return})})});$(".search").on("click",function(){var e=$("#address").val();AMap.service(["AMap.PlaceSearch"],function(){var t=new AMap.PlaceSearch({map:map});t.search(e,function(e,t){console.log(t);if(t.info=="OK"){var a=t.poiList.pois[0].location.lng;var i=t.poiList.pois[0].location.lat;var o=[a,i];map.setZoomAndCenter(19,o);getAddress(o,{success:function(e){var t=e.formattedAddress;var e={province:e.addressComponent.province,city:e.addressComponent.city,district:e.addressComponent.district,township:e.addressComponent.township};var a=""+e.province+e.city+e.district+e.township+"";t=t.replace(a,"");e.detail=t;var e=JSON.stringify(e);$(".address .edit-content").attr("data-address",e);$(".address .edit-content").text(t);$("#address").val(t)}});localStorage["lng"]=a;localStorage["lat"]=i;$("#container").attr("data-lng",a);$("#container").attr("data-lat",i);map.clearMap();marker=new AMap.Marker({icon:icon,map:map,position:o,draggable:true,cursor:"move",raiseOnDrag:true,clickable:true});marker.setMap(map);initMarker(marker)}else{$.toast("未查找到结果，请尝试修改查询条件")}})})});map.on("click",function(e){$(".amap-sug-result").css("visibility","hidden");map.clearMap();lnglatXY=[e.lnglat.getLng(),e.lnglat.getLat()];getAddress(lnglatXY,{success:function(e){var t=e.formattedAddress;var e={province:e.addressComponent.province,city:e.addressComponent.city,district:e.addressComponent.district,township:e.addressComponent.township};var a=""+e.province+e.city+e.district+e.township+"";t=t.replace(a,"");e.detail=t;var e=JSON.stringify(e);console.log(e);$(".address .edit-content").attr("data-address",e);$(".address .edit-content").text(t);$("#address").val(t)}});marker=new AMap.Marker({icon:icon,map:map,position:[e.lnglat.getLng(),e.lnglat.getLat()],draggable:true,cursor:"move",raiseOnDrag:true,clickable:true});localStorage["lng"]=e.lnglat.getLng();localStorage["lat"]=e.lnglat.getLat();$("#container").attr("data-lng",e.lnglat.getLng());$("#container").attr("data-lat",e.lnglat.getLat());marker.setMap(map);initMarker(marker)});